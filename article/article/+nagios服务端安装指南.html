<!DOCTYPE HTML>
<!--
	Dimension by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
 <head>
  <title>
   Dimension by HTML5 UP
  </title>
  <!-- <meta charset="utf-8" /> -->
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> -->
  <meta charset="utf-8"/>
  <meta content="width=device-width,initial-scale=1.0" name="viewport"/>
  <link href="../../assets/css/article.css" rel="stylesheet"/>
  <noscript>
   <link href="../../assets/css/noscript.css" rel="stylesheet"/>
  </noscript>
 </head>
 <body>
  <div id="app">
  </div>
  <!-- built files will be auto injected -->
 </body>
 <body class="is-article-visible">
  <!--	<body class="is-preload">-->
  <!-- Wrapper -->
  <div id="wrapper">
   <nav>
    <ul>
     <li>
      <a href="#intro">
       主页
      </a>
     </li>
     <li>
      <a href="#experience">
       文章列表
      </a>
     </li>
    </ul>
   </nav>
   <article class="active" id="article" style="display: block">
    <h1>
     nagios4 服务端安装指南（Ubuntu16.04）
    </h1>
    <hr/>
    <h2>
     一、依赖安装
    </h2>
    <p>
     <pre>sudo apt-get install wget build-essential apache2 php apache2-mod-php7.0 php-gd libgd-dev sendmail unzip</pre>
    </p>
    <h2>
     二、Nagios 4 安装
    </h2>
    <p>
     ```
sudo useradd nagios
sudo groupadd nagcmd
sudo usermod -a -G nagcmd nagios
apt-get update
apt-get install build-essential libgd2-xpm-dev openssl libssl-dev unzip
    </p>
    <p>
     cd ~
curl -L -O https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.3.4.tar.gz
tar zxf nagios-
     <em>
      .tar.gz
cd nagios-
     </em>
     ./configure --with-nagios-group=nagios --with-command-group=nagcmd
make all
sudo make install
sudo make install-commandmode
sudo make install-init
sudo make install-config
sudo /usr/bin/install -c -m 644 sample-config/httpd.conf /etc/apache2/sites-available/nagios.conf
sudo usermod -G nagcmd www-data
```
    </p>
    <h2>
     三、check_nrpe Plugin 安装（用户检测远程客户端）
    </h2>
    <p>
     <pre>cd ~
curl -L -O https://github.com/NagiosEnterprises/nrpe/releases/download/nrpe-3.2.1/nrpe-3.2.1.tar.gz
tar zxf nrpe-*.tar.gz
cd nrpe-*
./configure
make check_nrpe
sudo make install-plugin</pre>
    </p>
    <h2>
     四、插件安装
    </h2>
    <p>
     <pre>cd ~
curl -L -O http://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz
tar zxf nagios-plugins-*.tar.gz
cd nagios-plugins-*
./configure --with-nagios-user=nagios --with-nagios-group=nagios --with-openssl
make
sudo make install</pre>
    </p>
    <h2>
     五、Nagios配置文件设置
    </h2>
    <p>
     编辑文件 /usr/local/nagios/etc/nagios.cfg，将下面的语句前面的#号去掉
    </p>
    <p>
     ```
...
    </p>
    <h1>
     cfg_dir=/usr/local/nagios/etc/servers
    </h1>
    <p>
     ...
```
    </p>
    <p>
     改为：
    </p>
    <p>
     <pre>cfg_dir=/usr/local/nagios/etc/servers</pre>
    </p>
    <p>
     手动建立相应的目录
    </p>
    <p>
     <pre>sudo mkdir /usr/local/nagios/etc/servers</pre>
    </p>
    <p>
     编辑文件 sudo nano /usr/local/nagios/etc/objects/commands.cfg，在最后面加入下面的内容：
    </p>
    <p>
     <pre>...
define command{
        command_name check_nrpe
        command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$
}</pre>
    </p>
    <p>
     接下来运行下面的命令，重启相应的服务
    </p>
    <p>
     <pre>sudo a2enmod rewrite
sudo a2enmod cgi</pre>
    </p>
    <p>
     运行下面的第一天命令后输入相应的密码，命令最后面为账号名称，后面用于网页登录
    </p>
    <p>
     <pre>sudo htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
sudo ln -s /etc/apache2/sites-available/nagios.conf /etc/apache2/sites-enabled/</pre>
    </p>
    <p>
     新建文件 /etc/systemd/system/nagios.service，写入下面的内容
    </p>
    <p>
     ```
[Unit]
Description=Nagios
BindTo=network.target
    </p>
    <p>
     [Install]
WantedBy=multi-user.target
    </p>
    <p>
     [Service]
Type=simple
User=nagios
Group=nagios
ExecStart=/usr/local/nagios/bin/nagios /usr/local/nagios/etc/nagios.cfg
```
    </p>
    <p>
     首先启动Apache2后在启动nagios
    </p>
    <p>
     <pre>sudo systemctl restart apache2
sudo systemctl enable /etc/systemd/system/nagios.service
sudo systemctl start nagios</pre>
    </p>
    <p>
     输入下网址 http://nagios_server_public_ip/nagios 即可查看效果
    </p>
    <h2>
     六、DBI和DBD安装
    </h2>
    <p>
     在Ubuntu16.04中进行相应的搜索dbi和dbd后选择包含mysql字段的进行安装即可
    </p>
    <h2>
     七、ndo2db的安装
    </h2>
    <p>
     安装之前请确保MySQL的正确安装
    </p>
    <p>
     ```
cd /tmp
wget -O ndoutils.tar.gz https://github.com/NagiosEnterprises/ndoutils/releases/download/ndoutils-2.1.3/ndoutils-2.1.3.tar.gz
tar xzf ndoutils.tar.gz
cd /tmp/ndoutils-2.1.3/
./configure
make all
make install
    </p>
    <p>
     cd db/
./installdb -u 'ndoutils' -p 'ndoutils_password' -h 'localhost' -d nagios
cd .. 
```
    </p>
    <p>
     修改文件/usr/local/nagios/etc/ndo2db.cfg的数据库配置
    </p>
    <p>
     <pre>db_user=ndoutils
db_pass=ndoutils_password</pre>
    </p>
    <p>
     <pre>make install-config
mv /usr/local/nagios/etc/ndo2db.cfg-sample /usr/local/nagios/etc/ndo2db.cfg
sed -i 's/^db_user=.*/db_user=ndoutils/g' /usr/local/nagios/etc/ndo2db.cfg
sed -i 's/^db_pass=.*/db_pass=ndoutils_password/g' /usr/local/nagios/etc/ndo2db.cfg
mv /usr/local/nagios/etc/ndomod.cfg-sample /usr/local/nagios/etc/ndomod.cfg</pre>
    </p>
    <p>
     启动安装脚本不知道为什么不能运行了，只能在startup文件夹中运行default-init了
    </p>
    <p>
     接下来运行Apache2，在运行ndo2db，最后运行nagios
    </p>
    <p>
     使用下面的命令查看数据库有数据既为成功：
    </p>
    <p>
     <pre>echo 'select * from nagios.nagios_logentries;' | mysql -u ndoutils -p'ndoutils_password'</pre>
    </p>
    <h2>
     参考链接
    </h2>
    <ul>
     <li>
      <a href="https://www.howtoing.com/ubuntu-nagios/">
       如何在Ubuntu 16.04上安装Nagios服务器监控
      </a>
     </li>
     <li>
      <a href="https://sourceforge.net/projects/nagios/files/ndoutils-2.x/">
       ndoutils download
      </a>
     </li>
     <li>
      <a href="https://assets.nagios.com/downloads/nagioscore/docs/ndoutils/NDOUtils.pdf">
       NDOUTILS Documentation Version 2.x
      </a>
     </li>
     <li>
      <a href="https://www.cnblogs.com/jiang-dh/p/6409390.html">
       nagios 抓取数据插件ndoutils 学习
      </a>
     </li>
     <li>
      <a href="https://support.nagios.com/kb/article/ndoutils-installing-ndoutils-406.html">
       NDOUtils - Installing NDOUtils
      </a>
     </li>
    </ul>
   </article>
  </div>
  <!-- BG -->
  <div id="bg">
  </div>
  <!-- Scripts -->
  <script src="../../assets/js/jquery.min.js">
  </script>
  <script src="../../assets/js/browser.min.js">
  </script>
  <script src="../../assets/js/breakpoints.min.js">
  </script>
  <script src="../../assets/js/util.js">
  </script>
  <script src="../../assets/js/main.js">
  </script>
 </body>
</html>
