<!DOCTYPE HTML>
<!--
	Dimension by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
 <head>
  <title>
   Dimension by HTML5 UP
  </title>
  <!-- <meta charset="utf-8" /> -->
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> -->
  <meta charset="utf-8"/>
  <meta content="width=device-width,initial-scale=1.0" name="viewport"/>
  <link href="../../assets/css/article.css" rel="stylesheet"/>
  <noscript>
   <link href="../../assets/css/noscript.css" rel="stylesheet"/>
  </noscript>
 </head>
 <body>
  <div id="app">
  </div>
  <!-- built files will be auto injected -->
 </body>
 <body class="is-article-visible">
  <!--	<body class="is-preload">-->
  <!-- Wrapper -->
  <div id="wrapper">
   <nav>
    <ul>
     <li>
      <a href="#intro">
       主页
      </a>
     </li>
     <li>
      <a href="#experience">
       文章列表
      </a>
     </li>
    </ul>
   </nav>
   <article class="active" id="article" style="display: block">
    <h1>
     ShardingSphere RAW JDBC 分布式事务 Narayana XA 代码示例
    </h1>
    <hr/>
    <p>
     <em>
      项目工程在：
      <a href="https://github.com/lw1243925457/JAVA-000/tree/main/homework/shardingSphere-jdbc-example/transaction-example/transaction-2pc-narayana-xa-raw-jdbc-example">
       transaction-2pc-narayana-xa-raw-jdbc-example
      </a>
     </em>
    </p>
    <h2>
     代码简介
    </h2>
    <p>
     基于ShardingSphere的 Narayana XA实现一个简单的分布式事务应用demo
    </p>
    <h3>
     环境配置
    </h3>
    <p>
     启动两个MySQL5.7的docker镜像,下面命令直接复制运行即可：
    </p>
    <p>
     ```shell script
    </p>
    <h1>
     启动两个mysql
    </h1>
    <p>
     docker run --name mysql11 -p 3311:3306 -e MYSQL_ROOT_PASSWORD=root -e MYSQL_ROOT_HOST=% -d mysql:5.7
docker run --name mysql12 -p 3312:3306 -e MYSQL_ROOT_PASSWORD=root -e MYSQL_ROOT_HOST=% -d mysql:5.7
    </p>
    <h1>
     在11上创建数据库demo_ds_0，运行下面的SQL语句初始化数据库和表
    </h1>
    <p>
     docker exec -ti mysql11 mysql -u root -p
    </p>
    <p>
     create database demo_ds_0;
use demo_ds_0;
CREATE TABLE IF NOT EXISTS t_order_0 (order_id BIGINT NOT NULL, user_id INT NOT NULL, PRIMARY KEY (order_id));
CREATE TABLE IF NOT EXISTS t_order_1 (order_id BIGINT NOT NULL, user_id INT NOT NULL, PRIMARY KEY (order_id));
    </p>
    <h1>
     在12上创建数据库demo_ds_1，运行下面的SQL语句初始化数据库和表
    </h1>
    <p>
     docker exec -ti mysql12 mysql -u root -p
    </p>
    <p>
     create database demo_ds_1;
use demo_ds_1;
CREATE TABLE IF NOT EXISTS t_order_0 (order_id BIGINT NOT NULL, user_id INT NOT NULL, PRIMARY KEY (order_id));
CREATE TABLE IF NOT EXISTS t_order_1 (order_id BIGINT NOT NULL, user_id INT NOT NULL, PRIMARY KEY (order_id));
```
    </p>
    <h3>
     程序配置
    </h3>
    <h4>
     Maven依赖
    </h4>
    <p>
     核心依赖下面几个：
    </p>
    <p>
     ```xml
    </p>
    <?xml version="1.0" encoding="UTF-8"?>
    <p>
     <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemalocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelversion>
       4.0.0
      </modelversion>
     </project>
    </p>
    <pre><pre>&lt;groupId&gt;com.example&lt;/groupId&gt;
&lt;artifactId&gt;demo&lt;/artifactId&gt;
&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
&lt;name&gt;transaction-2pc-xa-raw-jdbc-example&lt;/name&gt;
&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

&lt;properties&gt;
    &lt;java.version&gt;1.8&lt;/java.version&gt;
&lt;/properties&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;mysql&lt;/groupId&gt;
        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;!-- Use 'netty-all' for 4.0 or above --&gt;
        &lt;version&gt;8.0.14&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;
        &lt;artifactId&gt;shardingsphere-jdbc-core&lt;/artifactId&gt;
        &lt;version&gt;5.0.0-alpha&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;
        &lt;artifactId&gt;shardingsphere-transaction-xa-core&lt;/artifactId&gt;
        &lt;version&gt;5.0.0-alpha&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!--    narayana xa config start  --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;
        &lt;artifactId&gt;shardingsphere-transaction-xa-narayana&lt;/artifactId&gt;
        &lt;version&gt;5.0.0-alpha&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss.narayana.jta&lt;/groupId&gt;
        &lt;artifactId&gt;jta&lt;/artifactId&gt;
        &lt;version&gt;5.9.9.Final&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss.narayana.jts&lt;/groupId&gt;
        &lt;artifactId&gt;narayana-jts-integration&lt;/artifactId&gt;
        &lt;version&gt;5.9.9.Final&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss&lt;/groupId&gt;
        &lt;artifactId&gt;jboss-transaction-spi&lt;/artifactId&gt;
        &lt;version&gt;7.6.0.Final&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss.logging&lt;/groupId&gt;
        &lt;artifactId&gt;jboss-logging&lt;/artifactId&gt;
        &lt;version&gt;3.4.1.Final&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--    narayana xa config  end --&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;
        &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;
        &lt;version&gt;2.2.5&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
                &lt;source&gt;7&lt;/source&gt;
                &lt;target&gt;7&lt;/target&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</pre></pre>
    <p>
    </p>
    ```
    <h3>
     shardingSphere数据库配置文件
    </h3>
    <p>
     如上面的docker数据库配置，这里设置了两个数据库，各自有两张表
    </p>
    <p>
     ```yaml
dataSources:
  ds_0: !!com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    jdbcUrl: jdbc:mysql://localhost:3311/demo_ds_0?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
    username: root
    password: root
    autoCommit: false
  ds_1: !!com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    jdbcUrl: jdbc:mysql://localhost:3312/demo_ds_1?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
    username: root
    password: root
    autoCommit: false
    </p>
    <p>
     rules:
- !SHARDING
  tables:
    t_order:
      actualDataNodes: ds_${0..1}.t_order_${0..1}
      databaseStrategy:
        standard:
          shardingColumn: user_id
          shardingAlgorithmName: database_inline
      tableStrategy:
        standard:
          shardingColumn: order_id
          shardingAlgorithmName: t_order_inline
  bindingTables:
    - t_order
    </p>
    <p>
     shardingAlgorithms:
    database_inline:
      type: INLINE
      props:
        algorithm-expression: ds_${user_id % 2}
    t_order_inline:
      type: INLINE
      props:
        algorithm-expression: t_order_${order_id % 2}
    </p>
    <p>
     props:
  sql-show: true
```
    </p>
    <h3>
     主程序
    </h3>
    <p>
     暴力直接的原生测试，代码如下：
    </p>
    <p>
     ```java
package com.example.demo;
    </p>
    <p>
     import org.apache.shardingsphere.driver.api.yaml.YamlShardingSphereDataSourceFactory;
import org.apache.shardingsphere.transaction.core.TransactionType;
import org.apache.shardingsphere.transaction.core.TransactionTypeHolder;
    </p>
    <p>
     import javax.sql.DataSource;
import java.io.File;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.sql.Statement;
    </p>
    <p>
     public class Transaction2pcXaRawJdbcExampleApplication {
    </p>
    <pre><pre>/**
 * 第一次插入数据正常运行成功
 * 第二次插入数据由于主键冲突，导致回滚
 */
public static void main(String[] args) throws IOException, SQLException {
    DataSource dataSource = getShardingDatasource();
    cleanupData(dataSource);

    TransactionTypeHolder.set(TransactionType.XA);

    Connection conn = dataSource.getConnection();
    String sql = "insert into t_order (user_id, order_id) VALUES (?, ?);";

    System.out.println("First XA Start insert data");
    try (PreparedStatement statement = conn.prepareStatement(sql)) {
        conn.setAutoCommit(false);
        for (int i = 1; i &lt; 11; i++) {
            statement.setLong(1, i);
            statement.setLong(2, i);
            statement.executeUpdate();
        }
        conn.commit();
    }

    System.out.println("First XA insert successful");

    // 设置id+5，如果设置XA事务成功，则所有的数据都不会插入
    // 设置id+5，如果设置XA事务不成功，则id大于10的数据就会插入到数据库
    // 程序运行完毕后，查看数据库，没有id大于10的数据，所以XA设置成功
    System.out.println("Second XA Start insert data");
    try (PreparedStatement statement = conn.prepareStatement(sql)) {
        conn.setAutoCommit(false);
        for (int i = 1; i &lt; 11; i++) {
            statement.setLong(1, i+5);
            statement.setLong(2, i+5);
            statement.executeUpdate();
        }
        conn.commit();
    } catch (Exception e) {
        System.out.println("Second XA insert failed");
        conn.rollback();
    } finally {
        conn.close();
    }
    System.out.println("Second XA insert successful");
}

private static void cleanupData(DataSource dataSource) {
    System.out.println("Delete all Data");
    try (Connection conn = dataSource.getConnection(); Statement statement = conn.createStatement()) {
        statement.execute("delete from t_order;");
        conn.commit();
    } catch (SQLException e) {
        e.printStackTrace();
    }
    System.out.println("Delete all Data successful");
}

/**
 * 生成DataSource，文件路径自行替换
 * @return
 * @throws IOException
 * @throws SQLException
 */
static private DataSource getShardingDatasource() throws IOException, SQLException {
    String fileName = "F:\\Code\\Java\\JAVA-000\\homework\\shardingSphere-jdbc-example\\transaction-example\\transaction-2pc-xa-raw-jdbc-example\\src\\main\\resources\\sharding-databases-tables.yaml";
    File yamlFile = new File(fileName);
    return YamlShardingSphereDataSourceFactory.createDataSource(yamlFile);
}
</pre></pre>
    <p>
     }
```
    </p>
   </article>
  </div>
  <!-- BG -->
  <div id="bg">
  </div>
  <!-- Scripts -->
  <script src="../../assets/js/jquery.min.js">
  </script>
  <script src="../../assets/js/browser.min.js">
  </script>
  <script src="../../assets/js/breakpoints.min.js">
  </script>
  <script src="../../assets/js/util.js">
  </script>
  <script src="../../assets/js/main.js">
  </script>
 </body>
</html>
