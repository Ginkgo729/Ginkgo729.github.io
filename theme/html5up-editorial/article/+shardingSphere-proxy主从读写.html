<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
 <head>
  <title>
   Editorial by HTML5 UP
  </title>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>
  <link href="../assets/css/main.css" rel="stylesheet"/>
 </head>
 <body class="is-preload">
  <!-- Wrapper -->
  <div id="wrapper">
   <!-- Main -->
   <div id="main">
    <div class="inner">
     <!-- Header -->
     <header id="header">
      <a class="logo" href="../index.html">
       <strong>
        每天进步一点点
       </strong>
      </a>
      <ul class="icons">
       <li>
        <a class="icon brands fa-twitter" href="#">
         <span class="label">
          Twitter
         </span>
        </a>
       </li>
       <li>
        <a class="icon brands fa-facebook-f" href="#">
         <span class="label">
          Facebook
         </span>
        </a>
       </li>
       <li>
        <a class="icon brands fa-snapchat-ghost" href="#">
         <span class="label">
          Snapchat
         </span>
        </a>
       </li>
       <li>
        <a class="icon brands fa-instagram" href="#">
         <span class="label">
          Instagram
         </span>
        </a>
       </li>
       <li>
        <a class="icon brands fa-medium-m" href="#">
         <span class="label">
          Medium
         </span>
        </a>
       </li>
      </ul>
     </header>
     <!-- Banner -->
     <section id="banner">
      <!-- <div class="content"> -->
      <article id="article">
       <h1>
        ShardingSphere Proxy 主从读写 入门使用
       </h1>
       <hr/>
       <p>
        <em>
         基于ShardingSphere5.0.0Alpha
        </em>
       </p>
       <h2>
        环境准备
       </h2>
       <h3>
        MySQL搭建
       </h3>
       <p>
        准备MySQL
       </p>
       <ul>
        <li>
         准备三个mysql，一主二从，搭建教程链接：
         <a href="https://github.com/lw1243925457/SE-Notes/blob/master/profession/system/software/MySQL/MysqlDocker%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE.md">
          Mysql docker 主从配置
         </a>
         <ul>
          <li>
           3306:主库
          </li>
          <li>
           3309、3310：从库
          </li>
         </ul>
        </li>
       </ul>
       <h3>
        配置ShardingSphere-Proxy
       </h3>
       <p>
        这里使用5.0.0版本的
       </p>
       <ul>
        <li>
         1.
         <a href="https://www.apache.org/dyn/closer.cgi/shardingsphere/5.0.0-alpha/apache-shardingsphere-5.0.0-alpha-shardingsphere-proxy-bin.tar.gz">
          下载ShardingSphere-Proxy
         </a>
        </li>
        <li>
         2.下载完成后解压放到自己的目录下,比如我这里是放到：D:/temp/ssp
        </li>
        <li>
         3.
         <a href="https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.47/mysql-connector-java-5.1.47.jar">
          下载MySQL-connect.jar
         </a>
        </li>
        <li>
         <p>
          4.将MySQL-connect.jar，放到ShardingSphere-Proxy根目录的lib下，比如我这里是：D:/temp/ssp/lib/
         </p>
        </li>
        <li>
         <p>
          5.写入配置文件，里面本身就有配置文件，这里需要写入的有两份，如果之前存在的就直接替换：server.xml和config-master_slave.yaml
         </p>
        </li>
       </ul>
       <p>
        server.xml 这份感觉不用改，如果和下面的一样就不用改
```java
       </p>
       <h6>
       </h6>
       <h1>
       </h1>
       <h1>
        If you want to configure orchestration, authorization and proxy properties, please refer to this file.
       </h1>
       <h1>
       </h1>
       <h6>
       </h6>
       <h1>
        orchestration:
       </h1>
       <h1>
        name: orchestration_ds
       </h1>
       <h1>
        overwrite: true
       </h1>
       <h1>
        registry:
       </h1>
       <h1>
        type: zookeeper
       </h1>
       <h1>
        serverLists: localhost:2181
       </h1>
       <h1>
        namespace: orchestration
       </h1>
       <p>
        authentication:
  users:
    root:
      password: root
    sharding:
      password: sharding
      authorizedSchemas: test
       </p>
       <p>
        props:
  max.connections.size.per.query: 1
  acceptor.size: 16  # The default value is available processors count * 2.
  executor.size: 16  # Infinite by default.
  proxy.frontend.flush.threshold: 128  # The default value is 128.
    # LOCAL: Proxy will run with LOCAL transaction.
    # XA: Proxy will run with XA transaction.
  # BASE: Proxy will run with B.A.S.E transaction.
  proxy.transaction.type: LOCAL
  proxy.opentracing.enabled: false
  query.with.cipher.column: true
  sql.show: false
```
       </p>
       <p>
        config-master_slave.yaml,这个文件的配置关键字一定不要安装官方example的那个来，完全不行，要按照官方文档来，比如JDBCURL需要改成url，大致的文件内容如下：
       </p>
       <p>
        ```java
       </p>
       <h6>
       </h6>
       <h1>
       </h1>
       <h1>
        Here you can configure the rules for the proxy.
       </h1>
       <h1>
        This example is configuration of master-slave rule.
       </h1>
       <h1>
       </h1>
       <h1>
        If you want to use master-slave, please refer to this file;
       </h1>
       <h1>
        if you want to use sharding, please refer to the config-sharding.yaml.
       </h1>
       <h1>
       </h1>
       <h6>
       </h6>
       <p>
        schemaName: test
       </p>
       <p>
        dataSources:
  master_ds:
    url: jdbc:mysql://localhost:3306/test?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
    username: root
    password: root
    connectionTimeoutMilliseconds: 30000
    idleTimeoutMilliseconds: 60000
    maxLifetimeMilliseconds: 1800000
    maxPoolSize: 50
  slave_ds_0:
    url: jdbc:mysql://localhost:3309/test?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
    username: root
    password: root
    connectionTimeoutMilliseconds: 30000
    idleTimeoutMilliseconds: 60000
    maxLifetimeMilliseconds: 1800000
    maxPoolSize: 50
  slave_ds_1:
    url: jdbc:mysql://localhost:3310/test?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
    username: root
    password: root
    connectionTimeoutMilliseconds: 30000
    idleTimeoutMilliseconds: 60000
    maxLifetimeMilliseconds: 1800000
    maxPoolSize: 50
       </p>
       <p>
        rules:
- !REPLICA_QUERY
  dataSources:
    master_ds:
      primaryDataSourceName: master_ds
      replicaDataSourceNames:
        - slave_ds_0
        - slave_ds_1
```
       </p>
       <h2>
        运行
       </h2>
       <p>
        经过前面的步骤基本配置差不多了，现在只需要运行Sharding-Proxy根目录下的 bin/start.bat就行了，运行命令大致如下：
       </p>
       <p>
        ```bash
       </p>
       <h1>
        进入相应的目录下，指定在13306端口运行，不指定默认运行在3307端口
       </h1>
       <p>
        .\start.bat 13306
```
       </p>
       <p>
        这里需要注意的是，Java11运行好像有点问题，需要用1.8来运行，而不确定Java运行版本的，可以直接写个脚本：start.bat(start.sh类似),整个脚本修改大致如下：
       </p>
       <p>
        ```bash
@rem
@rem Licensed to the Apache Software Foundation (ASF) under one or more
@rem contributor license agreements.  See the NOTICE file distributed with
@rem this work for additional information regarding copyright ownership.
@rem The ASF licenses this file to You under the Apache License, Version 2.0
@rem (the "License"); you may not use this file except in compliance with
@rem the License.  You may obtain a copy of the License at
@rem
@rem     http://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem
       </p>
       <p>
        @echo off &amp; setlocal enabledelayedexpansion
       </p>
       <p>
        cd %~dp0
       </p>
       <p>
        set SERVER_NAME=ShardingSphere-Proxy
       </p>
       <p>
        set CLASS_PATH="..;..\lib*;..\ext-lib*"
       </p>
       <p>
        set PORT=%1
       </p>
       <p>
        set CONFIG=%2
       </p>
       <p>
        if "%PORT%"=="-h" (
    goto print_usage
)
if "%PORT%"=="--help" (
    goto print_usage
)
       </p>
       <p>
        if "%PORT%"=="" (
set MAIN_CLASS=org.apache.shardingsphere.proxy.Bootstrap
) else ( if "%CONFIG%"=="" (
    set MAIN_CLASS=org.apache.shardingsphere.proxy.Bootstrap %PORT%
    echo The port is configured as %PORT%
    set CLASS_PATH=../conf;%CLASS_PATH%
    ) else (
    set MAIN_CLASS=org.apache.shardingsphere.proxy.Bootstrap %PORT% %CONFIG%
    echo The port is configured as %PORT%
    echo The configuration path is %CONFIG%
    set CLASS_PATH=../%CONFIG%;%CLASS_PATH%
    )
    echo The classpath is %CLASS_PATH%
)
       </p>
       <p>
        echo Starting the %SERVER_NAME% ...
       </p>
       <h1>
        在这里就直接设置死了Java的运行版本，如果不能正常运行，请去掉这行
       </h1>
       <p>
        F:\Software\Java\jdk1.8.0_261\bin\java.exe -server -Xmx2g -Xms2g -Xmn1g -Xss256k -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -Dfile.encoding=UTF-8 -classpath %CLASS_PATH% %MAIN_CLASS%
       </p>
       <p>
        goto exit
       </p>
       <p>
        :print_usage
 echo "usage: start.bat [port] [config_dir]"
 echo "  port: proxy listen port, default is 3307"
 echo "  config_dir: proxy config directory, default is conf"
 pause
       </p>
       <p>
        :exit
 pause
```
       </p>
       <p>
        运行正常的话，就可以看到刷刷刷的一排正常日志打出，这样就OK了
       </p>
       <h2>
        ShardingSphere Proxy连接测试
       </h2>
       <p>
        使用docker mysql命令有问题，成功连接了但是有bug，但使用MySQL workbench连接和程序连接是没有问题的
       </p>
       <h3>
        MySQL Workbench链接
       </h3>
       <p>
        使用图形化界面MySQL Workbench连接：本地ip、13306端口、root、root，连接成功，查询和删除，相应数据变化正确
       </p>
       <h3>
        Java JDBC连接测试
       </h3>
       <p>
        下面是整个测试代码，可直接运行，运行下来也没有问题：
       </p>
       <p>
        ```java
package com.example.demo.shardingsphere.proxy.jdbc;
       </p>
       <p>
        import com.zaxxer.hikari.HikariDataSource;
import org.junit.jupiter.api.Test;
import org.springframework.transaction.annotation.Transactional;
       </p>
       <p>
        import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
       </p>
       <p>
        /*
        <em>
         * ShardingSphere Proxy Raw JDBC测试
        </em>
        /
public class ShardingSphereProxyRawJdbcTest {
       </p>
       <pre><pre>@Test @Transactional
public void test() throws SQLException {
    System.out.println("Start test");
    DataSource SSDataSource = createShardingSphereProxyDataSource();
    DataSource slaveDataSource = createSlaveDataSource();

    // 测试通过SSP是否数据修改和查询正常
    Connection ssCon = SSDataSource.getConnection();
    Statement ssState = ssCon.createStatement();
    ssState.execute("UPDATE `users` SET `money` = '200' WHERE (`id` = '1');");

    ResultSet ret = ssState.executeQuery("select * from test.users where id=1;");
    while (ret.next()) {
        System.out.println(ret.getLong("money"));
        assert ret.getLong("money") == 200;
    }

    // 测试从库是否数据同步更改
    Connection slaveCon = slaveDataSource.getConnection();
    Statement slaveState = slaveCon.createStatement();
    ResultSet ret2 = slaveState.executeQuery("select * from test.users where id=1;");
    while (ret2.next()) {
        System.out.println(ret2.getLong("money"));
        assert ret2.getLong("money") == 200;
    }

    ret2.close();
    ret.close();
    ssState.close();
    slaveState.close();
    ssCon.close();
    slaveCon.close();
}

private DataSource createSlaveDataSource() {
    HikariDataSource dataSource = new HikariDataSource();
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setJdbcUrl("jdbc:mysql://localhost:3309/test?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding" +
            "=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true");
    dataSource.setUsername("root");
    dataSource.setPassword("root");
    return dataSource;
}

private DataSource createShardingSphereProxyDataSource() {
    HikariDataSource dataSource = new HikariDataSource();
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setJdbcUrl("jdbc:mysql://localhost:13306/test?serverTimezone=UTC&amp;useUnipre=true&amp;characterEncoding" +
            "=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true");
    dataSource.setUsername("root");
    dataSource.setPassword("root");
    return dataSource;
}
</pre></pre>
       <p>
        }
```
       </p>
       <h2>
        参考链接
       </h2>
       <ul>
        <li>
         <a href="https://developer.aliyun.com/article/771099">
          Sharding-Proxy的基本功能使用
         </a>
        </li>
        <li>
         <a href="https://www.programmersought.com/article/48586082376/">
          The sharding-proxy read-write separation study notes of shardingsphere
         </a>
        </li>
       </ul>
      </article>
      <!-- </div> -->
     </section>
    </div>
   </div>
   <!-- Sidebar -->
   <div id="sidebar">
    <div class="inner">
     <!-- Menu -->
     <nav id="menu">
      <header class="major">
       <h2>
        目录
       </h2>
      </header>
      <ul>
       <li>
        <span class="opener">
         系统与软件
        </span>
        <ul>
         <li>
          <span class="opener">
           linux
          </span>
          <ul>
           <li>
            <a href="index.html">
             zsh.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           software
          </span>
          <ul>
           <li>
            <span class="opener">
             vscode
            </span>
            <ul>
             <li>
              <a href="index.html">
               vscode使用配置记录.md
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           windows
          </span>
          <ul>
           <li>
            <a href="index.html">
             winSh中使用vim.md
            </a>
           </li>
          </ul>
         </li>
        </ul>
       </li>
       <li>
        <span class="opener">
         编程类
        </span>
        <ul>
         <li>
          <span class="opener">
           C++
          </span>
          <ul>
           <li>
            <a href="index.html">
             windows环境配置.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           git
          </span>
          <ul>
           <li>
            <a href="index.html">
             gitlab-CI.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           GoLang
          </span>
          <ul>
           <li>
            <a href="index.html">
             Go设置使用记录.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           java
          </span>
          <ul>
           <li>
            <span class="opener">
             spring
            </span>
            <ul>
             <li>
              <a href="index.html">
               SpringBoot-Mybatis-MySQL主从分离读写.md
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           openCV
          </span>
          <ul>
           <li>
            <a href="index.html">
             轮廓检测.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           python
          </span>
          <ul>
           <li>
            <a href="index.html">
             Python3常用记录.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           SFML
          </span>
          <ul>
           <li>
            <a href="index.html">
             SFML与VS2015配置.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           人工智能
          </span>
          <ul>
           <li>
            <span class="opener">
             机器学习
            </span>
            <ul>
             <li>
              <a href="index.html">
               朴素贝叶斯分类器.md
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           前端
          </span>
          <ul>
           <li>
            <a href="index.html">
             vue打包直接访问.md
            </a>
           </li>
          </ul>
         </li>
         <li>
          <span class="opener">
           开源
          </span>
          <ul>
           <li>
            <span class="opener">
             soul
            </span>
            <ul>
             <li>
              <a href="index.html">
               soul源码解析9-插件配置加载初探.md
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
        </ul>
       </li>
       <li>
        <span class="opener">
         通用类
        </span>
        <ul>
         <li>
          <a href="index.html">
           搜索技巧总结.md
          </a>
         </li>
        </ul>
       </li>
      </ul>
     </nav>
    </div>
   </div>
  </div>
  <!-- Scripts -->
  <script src="../assets/js/jquery.min.js">
  </script>
  <script src="../assets/js/browser.min.js">
  </script>
  <script src="../assets/js/breakpoints.min.js">
  </script>
  <script src="../assets/js/util.js">
  </script>
  <script src="../assets/js/main.js">
  </script>
 </body>
</html>